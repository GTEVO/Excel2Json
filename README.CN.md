# Excel行转化为复杂json对象的原理

将json对象用树形结构表示，每个子节点占用一个单元格，将这个结构填到Excel中，并将节点名和节点类型隔行排列，即为该json结构配置表的表头。
每个叶子节点对应一列，紧凑排列成一行。读取值时，按行读取，将单元格中的值按照json对象的树形结构进行还原，即可得到目标结构的json对象。

## 一、基础行

    当json结构不包含数组时，仅用一行则可以表示一个json对象的值，我们将这行定义为**【基础行】**。

## 二、扩展行

    当json结构包含数组时，由于每个数组元素对象占用一行，因此当存在数组节点时，数组会将父节点占用的行数提高为数组元素的个数，从而可能超过一行。
我们将数组元素占用的非基础行定义为**【扩展行】**。

### a. 多个但不嵌套的数组结构

    当存在多个但不嵌套的数组结构时，一个节点占用的行数等于子节点数组中元素数量最多的那个数组的元素数量。

### b. 嵌套数组结构

    当存在嵌套数组时，节点占用行数的计算会更加复杂，因为下层数组的扩展行行数会影响上层数组的元素的扩展行的位置。

### c. 数组结束的判断

1. 用于表示数组元素行上子节点对应的列全为空值。
2. 根据一、二的说明，当读取到基础行时，则数组读取完毕。在Excel中其特征为数组节点的兄弟节点行存在非空值，则该行已经超出数组读取范围。

### d. 读取数组结构
    由于a、b、c提到的原因，每次读取一个元素时需要将数组占用的最大行号向上传递，上层数组才能确定下一个扩展列的位置。

## 缺陷

2D数组是没办法通过单元格内的值来（构建基础行，从而）判断第一层数组的开始和结束位置，需要额外的符号来标记，为了简化Excel的配置难度，直接放弃支持2D数组。

## 三、Excel配置格式

### a、表头

#### 1、文档类型

    类型标记位于第一行第一列，可选项为{}、[]、<>，分别表示简单对象、数组、字典。

#### 2、节点树

    (a) 表头的开始列，为第一行从左到右首个$字符所在的列
    (b) 表头的结束列，为第一行从左到右首个#字符所在的列
    (c) 表头的结束行，为结束列从上到下（不包含第1行）首个#字符所在的行
    (d) 第一列的第二行开始到表头结束行，可选项为##var、##type，分别表示变量名行、类型行。其余值则忽略，因此可以将一些行当作注释用。
    (e) 类型可选项为b、i、f、s、[]、{}，分别表示布尔值、整数、浮点数、字符串、数组、对象。
    (f) 变量类型标识，变量名下方的首个非空类型单元格内的类型。
    (g) 数组子节点只支持基本类型（b、i、f、s）和对象，当为对象时，省略类型标记。

### b、内容

表头往下的行则为内容行，用于填写配置的具体数值。

第一列中，选项为value的行标识一个元素（字典的键值对、数组的单个元素）的起始行，选项为#的行标识文档结束。

## 四、其他

目标框架net9，可以修改为其他版本。发布二进制可运行文件时，启用ReadyToRun编译可以提高性能，文件体积会稍微大些。Clone到本地后可以直接用VsCode打开，安装C#扩展，直接运行调试，会将Data目录下的测试文件转化为json文件。